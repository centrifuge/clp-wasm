<!DOCTYPE html>
<html>
  <head>
    <title>CPPLEX TestBed</title>
    <meta content="" />
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
      integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
      crossorigin="anonymous"
    />
    <style>
      html,
      body {
        height: 100vh;
      }
      .border {
        border: 1px solid red;
      }
      textarea {
        width: 100%;
        font-family: "Courier New", Courier, monospace;
        font-size: small;
      }
    </style>
  </head>
  <body onload="init()">
    <script src="bn.js" type="text/javascript"></script>
    <script src="cpplex.js" type="text/javascript"></script>
    <div class="container-fluid">
      <div class="row">
        <div class="col">
          <h5>Test case</h5>
          <textarea id="testCase" rows="40"></textarea>
          <div class="btn btn-primary" onclick="solveProblemFromTestCase()">
            Solve
          </div>
        </div>
        <div class="col">
          <div class="container-fluid" style="height: 100%">
            <div class="row h-50">
              <div class="col">
                <h5>Problem</h5>
                <textarea id="lpProblem" rows="15"></textarea>
                <div class="btn btn-primary" onclick="solveProblemFromFromLP()">
                  Solve
                </div>
              </div>
            </div>
            <div class="row h-50">
              <div class="col">
                <h5>Solution</h5>
                <textarea id="solution" rows="15"></textarea>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const testCase = {
        state: {
          netAssetValue: {
            base: 18,
            value: 800,
          },
          reserve: {
            base: 18,
            value: 200,
          },
          seniorAsset: {
            base: 18,
            value: 800,
          },
          maxSeniorRatio: {
            base: 27,
            value: 0.85,
          },
          minSeniorRatio: {
            base: 27,
            value: 0.8,
          },
          maxReserve: {
            base: 18,
            value: 10000,
          },
        },
        orders: {
          supplySenior: {
            base: 18,
            value: 400,
          },
          redeemSenior: {
            base: 18,
            value: 300,
          },
          supplyJunior: {
            base: 18,
            value: 200,
          },
          redeemJunior: {
            base: 18,
            value: 100,
          },
        },
        solution: {
          supplySenior: {
            base: 18,
            value: 400,
          },
          redeemSenior: {
            base: 18,
            value: 300,
          },
          supplyJunior: {
            base: 18,
            value: 125,
          },
          redeemJunior: {
            base: 18,
            value: 100,
          },
        },
      };

      let testCaseElmt = null;
      let lpProblemElmt = null;
      let solutionElmt = null;

      function init() {
        testCaseElmt = document.getElementById("testCase");
        lpProblemElmt = document.getElementById("lpProblem");
        solutionElmt = document.getElementById("solution");
        testCaseElmt.value = JSON.stringify(testCase, null, 4);

        // lpProblemElmt.value = prepareProblemFromTestCase();
        lpProblemElmt.value = trivialProblem;
      }

      function objToNum(jsonNumber) {
        if (typeof jsonNumber == "string")
          return new BN(jsonNumber);
        return new BN(jsonNumber.value * 10000).mul(
          new BN(10).pow(new BN(jsonNumber.base - 5))
        );
      }

      function objToNumStr(jsonNumber) {
        return objToNum(jsonNumber).toString();
      }

      function prepareProblemFromTestCase() {
        const weights = {
          seniorRedeem: 1000000,
          juniorRedeem: 100000,
          juniorSupply: 10000,
          seniorSupply: 1000,
        };

        const tinInvestWeight = weights.juniorSupply;
        const tinRedeemWeight = weights.juniorRedeem;
        const dropInvestWeight = weights.seniorSupply;
        const dropRedeemWeight = weights.seniorRedeem;

        const testCase = JSON.parse(testCaseElmt.value);

        const state = testCase.state;
        const orders = testCase.orders;

        const e27 = objToNum({ value: 1, base: 27 });

        const tinInvestOrders = objToNum(orders.supplyJunior);
        const tinRedeemOrders = objToNum(orders.redeemJunior);
        const dropInvestOrders = objToNum(orders.supplySenior);
        const dropRedeemOrders = objToNum(orders.redeemSenior);

        const minDropRatio = objToNum(state.minSeniorRatio);
        const maxDropRatio = objToNum(state.maxSeniorRatio);
        const maxTinRatio = e27.sub(minDropRatio);
        const minTinRatio = e27.sub(maxDropRatio);

        const netAssetValue = objToNum(state.netAssetValue);
        const seniorAsset = objToNum(state.seniorAsset);
        const reserve = objToNum(state.reserve);
        const maxReserve = objToNum(state.maxReserve);

        //   name: 'minTINRatio',
        //   vars: [
        //     { name: 'tinRedeem', coef: -(1 - state.minTinRatio) },
        //     { name: 'dropRedeem', coef: state.minTinRatio },
        //     { name: 'tinInvest', coef: 1 - state.minTinRatio },
        //     { name: 'dropInvest', coef: -state.minTinRatio },
        //   ],
        //   bnds: {
        //     type: glpk.GLP_LO,
        //     ub: 0.0,
        //     lb:
        //       -(1 - state.minTinRatio) * state.netAssetValue -
        //       (1 - state.minTinRatio) * state.reserve +
        //       state.seniorAsset,
        //   },
        td = (obj) => obj.value * Math.pow(10, obj.base);

        minTr = state.maxSeniorRatio.value;
        let tmp =
          -(1 - minTr) * td(state.netAssetValue) -
          (1 - minTr) * td(state.reserve) +
          td(state.seniorAsset);
        console.log(tmp);

        const minTINRatioLb = maxDropRatio
          .neg()
          .mul(netAssetValue)
          .sub(maxDropRatio.mul(reserve))
          .add(seniorAsset.mul(e27));

        //   name: 'maxTINRatio',
        //   vars: [
        //     { name: 'tinInvest', coef: -(1 - state.maxTinRatio) },
        //     { name: 'dropInvest', coef: state.maxTinRatio },
        //     { name: 'tinRedeem', coef: 1 - state.maxTinRatio },
        //     { name: 'dropRedeem', coef: -state.maxTinRatio },
        //   ],
        //   bnds: {
        //     type: glpk.GLP_LO,
        //     ub: 0.0,
        //     lb:
        //       (1 - state.maxTinRatio) * state.netAssetValue +
        //       (1 - state.maxTinRatio) * state.reserve -
        //       state.seniorAsset,
        //   },

        const maxTINRatioLb = minDropRatio
          .mul(netAssetValue)
          .add(minDropRatio.mul(reserve))
          .sub(seniorAsset.mul(e27));

        const template = `[METADATA]
name Tinlake Solver (WIP)
vars 4
[VARIABLES]
0       tinInvest       ${tinInvestOrders}
0       dropInvest      ${dropInvestOrders}
0       tinRedeem       ${tinRedeemOrders}
0       dropRedeem      ${dropRedeemOrders}
[CONSTRAINTS]
1 1 -1 -1 < ${reserve}
1 1 -1 -1 > ${reserve.sub(maxReserve)}
${maxDropRatio} ${minTinRatio.neg()} ${maxDropRatio.neg()} ${minTinRatio} > ${minTINRatioLb}
${minDropRatio.neg()} ${maxTinRatio} ${minDropRatio} ${maxTinRatio.neg()} > ${maxTINRatioLb}
[OBJECTIVE]
maximize ${tinInvestWeight} ${dropInvestWeight} ${tinRedeemWeight} ${dropRedeemWeight}
`;
        return template;
      }

      const trivialProblem = `[METADATA]
name Tinlake Solver POC
vars 2
[VARIABLES]
0       s      10000000000000000000
0       r      8000000000000000000
[CONSTRAINTS]
1 -1 < -1
[OBJECTIVE]
maximize 1 1
      `;

      Module.onRuntimeInitialized = async (_) => {
        solveProblemFromFromLP();
      };

      function solveLpProblem(lpProblem) {
        const simplex = new Module.Simplex("Trivial");
        simplex.load_problem(lpProblem);
        simplex.solve();
        const solution = simplex.get_solution();
        simplex.delete();
        return solution;
      }

      function solveProblemFromFromLP() {
        const solution = solveLpProblem(lpProblemElmt.value);
        const solObj = JSON.parse(solution);
        for (let i in solObj)
          if (typeof solObj[i] == "string" && solObj[i].length > 25) {
            solObj[i] = Module.bn_round(solObj[i]); 
            // solObj[i] = solObj[i].split(".")[0];
          }
        solutionElmt.value = JSON.stringify(solObj, null, 4);
      }

      function solveProblemFromTestCase() {
        lpProblemElmt.value = prepareProblemFromTestCase();
        solveProblemFromFromLP();
      }
    </script>
  </body>
</html>
